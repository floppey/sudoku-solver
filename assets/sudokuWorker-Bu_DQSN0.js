(function(){"use strict";const M=["1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G"],v=l=>typeof l.value=="string"&&l.value.trim()!=="",S=(l,i,s)=>{let a=!1;const h=[],{board:r,boardSize:f}=l,u=Math.sqrt(f);for(let e=0;e<u;e++)for(let o=0;o<u;o++)h.push(r.cells[i+e][s+o]);const n=new Map;for(const e of h)if(e.value===null){const o=e.options.sort().join(",");n.has(o)||n.set(o,[]),n.get(o).push(e)}for(const[e,o]of n.entries()){const p=e.split(",");if(o.length===p.length){for(const t of h)if(t.value===null&&!o.includes(t)){const c=t.options.length;t.options=t.options.filter(m=>!p.includes(m)),t.options.length!==c&&(a=!0)}const d=o[0].row,g=o[0].column;if(o.every(t=>t.row===d))for(let t=0;t<f;t++){if(s<=t&&t<s+u)continue;const c=r.cells[d][t];if(c.value===null){const m=c.options.length;c.options=c.options.filter(b=>!p.includes(b)),c.options.length!==m&&(a=!0)}}if(o.every(t=>t.column===g))for(let t=0;t<f;t++){if(i<=t&&t<i+u)continue;const c=r.cells[t][g];if(c.value===null){const m=c.options.length;c.options=c.options.filter(b=>!p.includes(b)),c.options.length!==m&&(a=!0)}}}}return a},w=(l,i,s)=>{if(l.board.cells[i][s].value!==null)return[];const{boardSize:a}=l,h=new Set(M.slice(0,a));for(let n=0;n<a;n++){const e=l.board.cells[i][n].value,o=l.board.cells[n][s].value;e!==null&&h.delete(e),o!==null&&h.delete(o)}const r=Math.sqrt(a),f=Math.floor(i/r)*r,u=Math.floor(s/r)*r;for(let n=f;n<f+r;n++)for(let e=u;e<u+r;e++){const o=l.board.cells[n][e].value;typeof o=="string"&&o.trim()!==""&&h.delete(o)}return Array.from(h)},y=(l,i=!1)=>{const s={...l},{boardSize:a}=s,h=Math.sqrt(a);let r=!1,f=0;do r=!1,s.board.cells.forEach((n,e)=>{n.forEach((o,p)=>{if(v(o)){o.options=[o.value];return}const d=w(s,e,p);d.length===1?(r=!0,o.value=d[0],o.options=[d[0]]):o.options.length!==d.length&&(r=!0,o.options=d)})}),f++;while(r&&f<20);s.board.cells.forEach(n=>{n.forEach(e=>{v(e)||e.options.forEach(o=>{const p=n.filter(t=>t.options.includes(o)).length,g=s.board.cells.map(t=>t[e.column]).filter(t=>t.options.includes(o)).length;if(p===1){e.value=o;return}if(g===1){e.value=o;return}})})});let u=!1;f=0;do{u=!1;for(let n=0;n<a;n+=h)for(let e=0;e<a;e+=h)u=S(s,n,e)||r;r=r||u,f++}while(u&&f<10);if(s.board.cells.forEach(n=>{n.forEach(e=>{v(e)||e.options.length===1&&(e.value=e.options[0],r=!0)})}),s.isCompleted=s.board.cells.every(n=>n.every(e=>v(e))),s.isCompleted)return s;if(!r&&i){let n=l.boardSize+1,e=[];if(s.board.cells.forEach(g=>{g.forEach(t=>{v(t)||(t.options.length<n&&(e=[],n=t.options.length),t.options.length===n&&e.push(t))})}),n===0)return s.moves[Math.floor(Math.random()*s.moves.length)].previousState;const o=e[Math.floor(Math.random()*e.length)],p=o.options[Math.floor(Math.random()*o.options.length)],d={row:o.row,column:o.column,value:p,previousState:{...s,board:{cells:s.board.cells.map(g=>g.map(t=>({...t,isFixed:t.isFixed})))}}};l.moves.push(d),o.value=p,o.options=[p]}return s};self.onmessage=function(l){try{let i;const s=l.data;let a=(s.boardSize===16,1e3);do{if(i=y(s,!0),i.isCompleted)break;a--}while(a>0);self.postMessage(i)}catch(i){console.error("Worker encountered an error:",i),self.postMessage(null)}},self.onerror=function(l){console.error("Worker script error:",l)}})();
